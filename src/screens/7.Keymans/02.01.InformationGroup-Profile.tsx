import React, { useMemo, useRef, useState, useEffect } from 'react';
import { View, Text, TouchableOpacity, StyleSheet, ScrollView, TextInput, Image, Platform, Modal, TouchableWithoutFeedback, Animated } from 'react-native';
import { Svg, Path, Rect, G, Defs, ClipPath } from 'react-native-svg';
import * as ImagePicker from 'expo-image-picker';
import {
  UF_LIST,
  formatNameInput,
  maskCPF,
  isValidCPF,
  isValidCNPJ,
  sanitizeEmail,
  isValidEmail,
  maskWhatsApp,
  validateWhatsApp,
  maskCEP,
  isValidCEP,
  sanitizeCityNeighborhood,
  sanitizeAddress,
  sanitizeNumberField,
  sanitizeComplement,
  capitalizeFirstLetterLive,
  formatNameFirstWordOnly,
} from '../../utils/validators';

// Cores do tema
const COLORS = {
  primary: '#1777CF',
  textPrimary: '#3A3F51',
  textSecondary: '#7D8592',
  textTertiary: '#91929E',
  labelText: '#64748B',
  background: '#F4F4F4',
  white: '#FCFCFC',
  border: '#D8E0F0',
  inputBorder: '#CBD5E1',
};

const KEYMAN_PHOTO_BY_NAME: Record<string, any> = {
  'Camila Betanea': require('../../../assets/0000001.png'),
  'Ruan de Londres': require('../../../assets/0000002.png'),
  'Gabriela de Assis': require('../../../assets/0000003.png'),
};

const DEFAULT_AVATAR = require('../../../assets/AvatarPlaceholder02.png');

const ChevronDownIcon = () => (
  <Svg width="14" height="14" viewBox="0 0 24 24" fill="none">
    <Path d="M7 10l5 5 5-5" stroke="#7D8592" strokeWidth={2} strokeLinecap="round" strokeLinejoin="round" />
  </Svg>
);

const ClearIcon = () => (
  <Svg width="14" height="14" viewBox="0 0 24 24" fill="none">
    <Path d="M18 6L6 18M6 6l12 12" stroke="#7D8592" strokeWidth={2} strokeLinecap="round" strokeLinejoin="round" />
  </Svg>
);

function maskCNPJ(input: string): string {
  const digits = (input || '').replace(/\D+/g, '').slice(0, 14);
  const p1 = digits.slice(0, 2);
  const p2 = digits.slice(2, 5);
  const p3 = digits.slice(5, 8);
  const p4 = digits.slice(8, 12);
  const p5 = digits.slice(12, 14);
  let out = p1;
  if (p2) out += (out ? '.' : '') + p2;
  if (p3) out += (out ? '.' : '') + p3;
  if (p4) out += '/' + p4;
  if (p5) out += '-' + p5;
  return out;
}

const getPlaceholderForField = (field: keyof ProfileFormData, personType: PersonType): string => {
  if (field === 'nome') return 'Nome completo';
  if (field === 'cpfCnpj') return personType === 'fisica' ? '000.000.000-00' : '00.000.000/0000-00';
  if (field === 'email') return 'Email@teste.com';
  if (field === 'whatsapp') return '00 00000-0000';
  if (field === 'estado') return 'São Paulo';
  if (field === 'cep') return '00000-000';
  if (field === 'cidade') return 'Digite o nome da sua cidade';
  if (field === 'bairro') return 'Digite o nome do seu bairro';
  if (field === 'endereco') return 'Digite seu endereço';
  if (field === 'numero') return 'Digite o número do seu endereço';
  if (field === 'complemento') return 'Ex: bloco A, sala 10, apartamento 5';
  return '';
};


// Ícone da câmera para foto
const CameraIcon = () => (
  <Svg width="25" height="24" viewBox="0 0 26 24" fill="none">
    <Rect x="0" y="0" width="26" height="24" rx="12" fill={COLORS.border} />
    <Rect x="0.1" y="0.1" width="25.8" height="23.8" rx="11.9" stroke={COLORS.border} strokeWidth="0.2" />
    <G transform="translate(-4 -4)">
      <Path
        d="M24.0455 11.0571H21.5255C21.4057 11.0571 21.2878 11.0292 21.1823 10.9759C21.0767 10.9226 20.9868 10.8456 20.9204 10.7517L20.1135 9.61063C19.9806 9.42279 19.8007 9.26878 19.5896 9.16226C19.3784 9.05574 19.1427 9 18.9033 9H16.0967C15.8573 9 15.6216 9.05574 15.4104 9.16226C15.1993 9.26878 15.0194 9.42279 14.8865 9.61063L14.0796 10.7517C14.0132 10.8456 13.9233 10.9226 13.8177 10.9759C13.7122 11.0292 13.5943 11.0571 13.4745 11.0571H13.1364V10.7143C13.1364 10.6234 13.0981 10.5361 13.0299 10.4718C12.9617 10.4076 12.8692 10.3714 12.7727 10.3714H11.6818C11.5854 10.3714 11.4929 10.4076 11.4247 10.4718C11.3565 10.5361 11.3182 10.6234 11.3182 10.7143V11.0571H10.9545C10.5688 11.0571 10.1988 11.2016 9.92603 11.4588C9.65325 11.716 9.5 12.0648 9.5 12.4286V19.6286C9.5 19.9923 9.65325 20.3411 9.92603 20.5983C10.1988 20.8555 10.5688 21 10.9545 21H24.0455C24.4312 21 24.8012 20.8555 25.074 20.5983C25.3468 20.3411 25.5 19.9923 25.5 19.6286V12.4286C25.5 12.0648 25.3468 11.716 25.074 11.4588C24.8012 11.2016 24.4312 11.0571 24.0455 11.0571ZM17.5 19.6286C16.6729 19.6286 15.8644 19.3973 15.1767 18.9641C14.489 18.5308 13.953 17.915 13.6365 17.1946C13.32 16.4741 13.2372 15.6813 13.3985 14.9165C13.5599 14.1517 13.9582 13.4491 14.543 12.8977C15.1278 12.3463 15.873 11.9708 16.6842 11.8186C17.4954 11.6665 18.3362 11.7446 19.1003 12.043C19.8644 12.3414 20.5176 12.8468 20.9771 13.4952C21.4366 14.1436 21.6818 14.9059 21.6818 15.6857C21.6818 16.7314 21.2412 17.7343 20.457 18.4737C19.6727 19.2132 18.6091 19.6286 17.5 19.6286Z"
        fill={COLORS.textPrimary}
      />
      <Path
        d="M17.5 13.1143C16.9606 13.1143 16.4333 13.2651 15.9848 13.5476C15.5363 13.8302 15.1867 14.2318 14.9803 14.7017C14.7739 15.1715 14.7199 15.6886 14.8251 16.1874C14.9304 16.6862 15.1901 17.1444 15.5715 17.504C15.9529 17.8636 16.4389 18.1085 16.9679 18.2077C17.497 18.307 18.0453 18.256 18.5437 18.0614C19.042 17.8668 19.468 17.5372 19.7676 17.1143C20.0673 16.6915 20.2273 16.1943 20.2273 15.6857C20.2273 15.0037 19.9399 14.3497 19.4285 13.8674C18.917 13.3852 18.2233 13.1143 17.5 13.1143ZM17.5 17.2286C17.0662 17.2281 16.6502 17.0654 16.3434 16.7762C16.0367 16.4869 15.8641 16.0948 15.8636 15.6857C15.8636 15.5948 15.9019 15.5076 15.9701 15.4433C16.0383 15.379 16.1308 15.3429 16.2273 15.3429C16.3237 15.3429 16.4162 15.379 16.4844 15.4433C16.5526 15.5076 16.5909 15.5948 16.5909 15.6857C16.5909 15.913 16.6867 16.1311 16.8572 16.2918C17.0277 16.4526 17.2589 16.5429 17.5 16.5429C17.5964 16.5429 17.6889 16.579 17.7571 16.6433C17.8253 16.7076 17.8636 16.7948 17.8636 16.8857C17.8636 16.9766 17.8253 17.0639 17.7571 17.1282C17.6889 17.1924 17.5964 17.2286 17.5 17.2286Z"
        fill={COLORS.textPrimary}
      />
    </G>
  </Svg>
);

// Ícone Radio selecionado
const RadioSelectedIcon = () => (
  <Svg width="20" height="20" viewBox="0 0 20 20" fill="none">
    <G clipPath="url(#clip0)">
      <Path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M20 10C20 4.47715 15.5228 0 10 0C4.47715 0 0 4.47715 0 10C0 15.5228 4.47715 20 10 20C15.5228 20 20 15.5228 20 10ZM2 10C2 5.58172 5.58172 2 10 2C14.4183 2 18 5.58172 18 10C18 14.4183 14.4183 18 10 18C5.58172 18 2 14.4183 2 10Z"
        fill={COLORS.primary}
      />
      <Rect x="5" y="5" width="10" height="10" rx="5" fill={COLORS.primary} />
    </G>
    <Defs>
      <ClipPath id="clip0">
        <Rect width="20" height="20" fill="white" />
      </ClipPath>
    </Defs>
  </Svg>
);

// Ícone Radio não selecionado
const RadioUnselectedIcon = () => (
  <Svg width="20" height="20" viewBox="0 0 20 20" fill="none">
    <G clipPath="url(#clip1)">
      <Path
        fillRule="evenodd"
        clipRule="evenodd"
        d="M20 10C20 4.47715 15.5228 0 10 0C4.47715 0 0 4.47715 0 10C0 15.5228 4.47715 20 10 20C15.5228 20 20 15.5228 20 10ZM2 10C2 5.58172 5.58172 2 10 2C14.4183 2 18 5.58172 18 10C18 14.4183 14.4183 18 10 18C5.58172 18 2 14.4183 2 10Z"
        fill="#6F7DA0"
        stroke={COLORS.white}
      />
    </G>
    <Defs>
      <ClipPath id="clip1">
        <Rect width="20" height="20" fill="white" />
      </ClipPath>
    </Defs>
  </Svg>
);




const WhatsAppIcon = () => (
  <Svg width="17" height="17" viewBox="0 0 17 17" fill="none">
    <Path
      d="M8.49121 0.0498047C10.739 0.0506959 12.8509 0.922379 14.4385 2.50391C16.0485 4.10809 16.9343 6.21201 16.9336 8.42773L16.9229 8.84473C16.8192 10.9203 15.9495 12.8604 14.4473 14.3467C12.8489 15.9281 10.7336 16.7988 8.49121 16.7988H8.48828C7.17104 16.7983 5.86473 16.4873 4.69434 15.8975L4.67871 15.8896L4.66113 15.8936L0.0888672 16.9326L1.08301 12.415L1.08691 12.3965L1.07812 12.3799C0.404793 11.1365 0.0501382 9.77486 0.0498047 8.42578V8.4209C0.0519866 6.19069 0.9343 4.08584 2.53516 2.50195C4.13325 0.920626 6.24854 0.0498624 8.49121 0.0498047ZM8.49121 1.27637C4.51587 1.27637 1.2789 4.48454 1.27637 8.42383C1.27637 9.64159 1.61989 10.8752 2.26758 11.9922L2.38574 12.1982L1.71973 15.2314L1.70312 15.3086L1.7793 15.291L4.85254 14.5918L5.05566 14.7021C6.1033 15.2709 7.29032 15.5717 8.48828 15.5723H8.49121C12.4676 15.5723 15.7053 12.3679 15.707 8.42773C15.7077 6.54001 14.9494 4.74446 13.5732 3.37305C12.217 2.02209 10.4117 1.27718 8.49121 1.27637ZM6.18066 4.75977C6.249 4.7626 6.30982 4.76742 6.37109 4.80371C6.43288 4.84036 6.50194 4.91448 6.57227 5.07031C6.65814 5.26065 6.79415 5.5942 6.91504 5.89355C7.03488 6.19033 7.14131 6.4575 7.16699 6.50879C7.21235 6.59925 7.23789 6.69416 7.18359 6.80273C7.11668 6.93605 7.09282 7.00915 7.00098 7.11621C6.90536 7.22737 6.78844 7.34405 6.70117 7.43066C6.65382 7.47765 6.59516 7.53592 6.56738 7.61035C6.53795 7.68947 6.54503 7.77988 6.60742 7.88672C6.7215 8.08168 7.12548 8.74214 7.70898 9.26074C8.457 9.92545 9.08512 10.1374 9.27539 10.2324C9.37579 10.2825 9.46378 10.3077 9.54492 10.2979C9.62815 10.2877 9.69543 10.242 9.75684 10.1719C9.86982 10.0431 10.253 9.59321 10.3848 9.39648C10.4442 9.3076 10.4979 9.2784 10.5498 9.27246C10.6071 9.26602 10.6733 9.28566 10.7637 9.31836C10.8497 9.34969 11.1292 9.48313 11.415 9.62305C11.6993 9.76217 11.9859 9.90563 12.083 9.9541C12.1827 10.0037 12.2595 10.0385 12.3213 10.0723C12.3831 10.106 12.4176 10.133 12.4346 10.1611C12.4402 10.1709 12.4489 10.2003 12.4531 10.2539C12.4571 10.3053 12.4561 10.3727 12.4 10.4346C12.3439 10.4965 12.2807 10.5407 12.207 10.5635C12.0635 10.6367 11.6179 10.8857 11.415 11.0078C10.7225 11.4232 9.91938 11.5576 9.16602 11.4043C8.40202 11.2473 7.73335 10.819 7.30078 10.207C6.83783 9.5527 6.46762 8.83124 6.20117 8.06836C6.18157 8.01049 6.15425 7.96656 6.1084 7.94043C6.06308 7.91456 6.00203 7.90665 5.9375 7.91797C5.67852 7.96462 5.52025 8.05596 5.39258 8.18555C5.26491 8.31514 5.17385 8.46886 5.12793 8.63477C5.10284 8.70804 5.10758 8.77993 5.13477 8.83984C5.1999 8.98344 5.44358 9.49375 5.7207 9.99023C6.12672 10.7123 6.59886 11.3734 7.12891 11.9688C7.55702 12.4478 8.03653 12.8823 8.56055 13.2656C8.97787 13.5729 9.93653 14.2185 10.3496 14.418C10.4486 14.4933 10.5468 14.5209 10.6406 14.5068C10.7225 14.4942 10.7981 14.451 10.8496 14.3867C11.0809 14.1316 11.3931 13.7852 11.6836 13.4414C11.7953 13.308 11.8206 13.1831 11.7871 13.0762C11.7597 12.9899 11.7058 12.9299 11.6211 12.8887C11.4137 12.786 10.9559 12.574 10.9023 12.5566C10.5844 12.4522 10.2708 12.3234 9.9668 12.1719C9.9072 12.1416 9.85217 12.132 9.80078 12.1426C9.74925 12.1533 9.70126 12.1847 9.66602 12.2324C9.53946 12.4083 9.40456 12.5978 9.27344 12.7812C9.13055 12.9822 9.05363 13.1038 8.91992 13.2207C8.63533 13.4642 8.26012 13.5825 7.88379 13.5469C7.52433 13.5114 7.18049 13.3847 6.89648 13.1758C6.17362 12.6489 5.58968 12.0006 5.13281 11.3203C4.93864 11.0292 4.7645 10.7254 4.61133 10.4102C4.56855 10.3238 4.56095 10.2396 4.58984 10.1602C4.6187 10.0809 4.68121 10.0164 4.76367 9.97852C4.79878 9.96308 4.83669 9.95477 4.875 9.95312C4.95148 9.94979 5.02909 9.97275 5.09961 10.0195C5.38843 10.2116 5.79694 10.436 6.04102 10.5625C6.14532 10.615 6.24039 10.6103 6.32227 10.5527C6.3992 10.5008 6.4422 10.4202 6.44336 10.332C6.44594 10.1414 6.43853 9.90533 6.43359 9.85156C6.41721 9.65421 6.41579 9.45575 6.42969 9.25781C6.43849 9.13015 6.37409 9.03752 6.24023 8.98828C6.15615 8.95729 5.91152 8.88438 5.82422 8.85938C5.51105 8.76415 5.20785 8.64465 4.91602 8.50391C4.86418 8.47876 4.8236 8.43695 4.80273 8.38672C4.77382 8.32661 4.77946 8.2659 4.81836 8.2168C5.06285 7.99346 5.37084 7.85233 5.70508 7.80859C5.82629 7.79319 5.94034 7.87174 6.01953 7.99414C6.19492 8.27215 6.55692 8.67612 6.75 8.85938C6.77841 8.88697 6.81682 8.90059 6.85547 8.89844C6.89411 8.8963 6.93037 8.87862 6.95703 8.84961C7.05727 8.74139 7.21488 8.58501 7.32812 8.48047C7.37653 8.43927 7.43345 8.421 7.48828 8.42969C7.67134 8.45778 7.98734 8.52555 8.13281 8.56055C8.24852 8.58841 8.34822 8.62223 8.42969 8.65234C8.50041 8.67831 8.56661 8.71191 8.625 8.75391C8.66761 8.78842 8.69778 8.83079 8.71289 8.875C8.76066 9.01931 8.77379 9.17734 8.75 9.35352C8.73542 9.45895 8.78812 9.56241 8.88281 9.61719C9.0423 9.70931 9.25106 9.81613 9.34375 9.86133C9.42766 9.90225 9.50446 9.95205 9.57227 10.0098C9.61918 10.0378 9.65887 10.0783 9.6875 10.1289C9.70587 10.1607 9.80288 10.3413 9.85742 10.4395C9.9306 10.569 10.0103 10.6946 10.0957 10.8145C10.1845 10.9409 10.2789 11.0599 10.376 11.1719C10.4114 11.2118 10.4563 11.2456 10.5078 11.2715C10.5441 11.2972 10.5865 11.3067 10.6289 11.3008C10.7802 11.2866 10.906 11.2221 11 11.1094C11.1214 10.9697 11.2464 10.7994 11.3477 10.6426C11.3785 10.6048 11.4167 10.5755 11.458 10.5566C11.4939 10.5399 11.5341 10.5342 11.5723 10.541C11.6327 10.5522 11.6904 10.5762 11.7422 10.6113C11.815 10.6535 11.8774 10.7133 11.9258 10.7852C12.0328 10.9341 12.1583 11.049 12.2852 11.1289C12.317 11.1495 12.3516 11.161 12.3867 11.1641C12.4244 11.1672 12.4618 11.1564 12.4941 11.1348C12.5582 11.0976 12.616 11.0448 12.6641 10.9805C12.7026 10.9314 12.7213 10.8717 12.7148 10.8125C12.7068 10.7346 12.6915 10.6536 12.6777 10.5996C12.6533 10.4893 12.5929 10.3858 12.5059 10.3008C12.4293 10.2311 12.3354 10.1827 12.2324 10.1602C12.1428 10.1438 11.9823 10.118 11.9355 10.1113C11.6898 10.0948 11.4526 10.078 11.2227 10.0605C11.169 10.0574 11.1163 10.0715 11.0742 10.1016C10.9835 10.1632 10.9152 10.256 10.8789 10.3652C10.8467 10.459 10.8164 10.6475 10.8164 10.6523C10.8109 10.6934 10.7879 10.7304 10.7539 10.7539C10.7185 10.7778 10.6761 10.785 10.6367 10.7734C10.573 10.7591 10.5251 10.7182 10.5 10.6602C10.4788 10.6123 10.4531 10.5595 10.4238 10.501C10.368 10.3836 10.2893 10.2319 10.2305 10.1602C10.1144 10.022 9.97657 9.88615 9.83984 9.76172C9.77543 9.70425 9.74493 9.62083 9.75781 9.53711C9.78824 9.34002 9.82791 9.14065 9.87695 8.94141C9.88567 8.89978 9.87503 8.85605 9.84766 8.82227C9.82023 8.78858 9.77962 8.7695 9.73633 8.76953C9.61369 8.77164 9.49364 8.79724 9.38281 8.8457C9.21085 8.91146 9.0351 8.98957 8.86133 9.07617C8.77885 9.11302 8.69572 9.14971 8.61719 9.17188C8.56234 9.18692 8.50484 9.17981 8.45508 9.15234C8.36907 9.10564 8.29321 9.03469 8.23633 8.94727C8.17921 8.85854 8.13978 8.75677 8.12012 8.64844C8.10096 8.54241 8.09515 8.43215 8.10352 8.32227C8.1121 8.20658 8.15309 8.09546 8.2207 7.99805C8.26495 7.9382 8.33717 7.8957 8.41602 7.88672C8.54854 7.87166 8.81261 7.87522 8.95508 7.88672C9.04273 7.89648 9.13672 7.93848 9.19531 8.00293C9.24238 8.05451 9.26686 8.12012 9.26562 8.1875C9.26504 8.2273 9.28823 8.26355 9.32422 8.2832C9.36004 8.30278 9.40341 8.30284 9.43945 8.2832C9.50685 8.25207 9.57422 8.21198 9.63281 8.16895C9.67643 8.13613 9.71649 8.09877 9.75195 8.05859C9.79049 8.01115 9.84253 7.97831 9.89844 7.96484C9.96872 7.94806 10.0425 7.95094 10.1113 7.97266C10.2417 8.01385 10.3713 8.08565 10.4883 8.17773C10.5795 8.25064 10.7368 8.4051 10.8066 8.47852C10.877 8.55402 10.9154 8.64514 10.9141 8.73828C10.9133 8.7997 10.8916 8.85915 10.8535 8.90625C10.7623 9.02208 10.5825 9.23181 10.5273 9.28906C10.4684 9.34682 10.3851 9.38372 10.2969 9.39258C10.2802 9.39393 10.2502 9.39588 10.2344 9.39844C10.184 9.40706 10.1394 9.43038 10.1035 9.46484C10.0556 9.50983 10.017 9.56302 9.99023 9.62109C9.95179 9.69884 9.93057 9.78266 9.92773 9.86719C9.92458 9.96814 9.94586 10.0687 9.99023 10.1602C10.0256 10.2376 10.0794 10.3037 10.1465 10.3535C10.1658 10.3667 10.2237 10.4009 10.2461 10.4121C10.3521 10.4641 10.4553 10.5259 10.5547 10.5957C10.633 10.651 10.7188 10.6908 10.8086 10.7129C10.862 10.7241 10.9182 10.7219 10.9707 10.7061C11.0338 10.687 11.0908 10.6515 11.1367 10.6035C11.1885 10.5523 11.2237 10.4878 11.2383 10.416C11.253 10.345 11.2449 10.2703 11.2148 10.2041C11.1677 10.1085 11.0943 10.0286 11.0039 9.97266C10.9146 9.91836 10.8172 9.88208 10.7188 9.86523C10.5262 9.83259 10.3299 9.82851 10.1406 9.85352C10.0716 9.86241 10.0101 9.90094 9.96875 9.95898C9.9157 10.0315 9.87138 10.1036 9.83203 10.1758C9.7917 10.2523 9.7681 10.3368 9.76367 10.4238C9.75835 10.5243 9.77912 10.6264 9.82422 10.7168C9.87514 10.819 9.95173 10.9016 10.0469 10.9629C10.145 11.0259 10.2448 11.0586 10.3555 11.0625C10.4253 11.065 10.494 11.0486 10.5547 11.0156C10.6178 10.9813 10.6685 10.9277 10.7012 10.8613C10.7301 10.8027 10.7426 10.7391 10.7383 10.6758C10.734 10.6124 10.7129 10.5503 10.6777 10.4961C10.6201 10.4095 10.5393 10.3359 10.4434 10.2803C10.3493 10.2257 10.2467 10.1934 10.1445 10.1855C10.1113 10.183 10.0778 10.183 10.0449 10.1855C9.92876 10.196 9.82078 10.2458 9.73633 10.3262C9.62264 10.4377 9.56113 10.5907 9.5625 10.75C9.55736 10.8185 9.57642 10.886 9.61523 10.9434C9.70938 11.0763 9.87852 11.1266 10.0234 11.0703C10.125 11.0306 10.2121 10.958 10.2715 10.8633C10.2926 10.8302 10.3149 10.7928 10.332 10.7578C10.3614 10.7018 10.4269 10.6702 10.4902 10.6797C10.6322 10.696 10.8737 10.7447 10.998 10.7754C11.0646 10.7933 11.136 10.8042 11.207 10.8086C11.2314 10.8078 11.2552 10.804 11.2773 10.7969C11.304 10.7879 11.3186 10.7591 11.3125 10.7305C11.2934 10.643 11.2415 10.5546 11.1719 10.4922C11.0972 10.4304 11.0013 10.3974 10.9023 10.3965C10.803 10.3956 10.7082 10.4256 10.6348 10.4883C10.504 10.6065 10.3926 10.7445 10.3066 10.8945C10.2167 11.049 10.173 11.2308 10.1836 11.4102C10.1919 11.543 10.2305 11.6713 10.2969 11.7871C10.351 11.8836 10.4369 11.9831 10.541 12.0684C10.6272 12.1385 10.7189 12.1967 10.8164 12.2402C10.9976 12.3163 11.2157 12.3533 11.4238 12.3398C11.5711 12.3301 11.7119 12.2786 11.8242 12.1953C11.9343 12.1099 12.0163 11.9936 12.0605 11.8633C12.1028 11.7372 12.1066 11.6021 12.0781 11.4707C12.0507 11.346 12.007 11.247 11.9336 11.1582C11.8306 11.0338 11.6837 10.9547 11.5234 10.9355C11.3621 10.915 11.2001 10.9655 11.0742 11.0742C10.9461 11.1906 10.8454 11.3664 10.8027 11.5605C10.7913 11.6083 10.7988 11.6598 10.8242 11.7012C10.8464 11.736 10.8809 11.7596 10.9199 11.7676C11.0095 11.785 11.1005 11.7806 11.1836 11.7559C11.5712 11.6381 11.9186 11.4311 12.1797 11.1602C12.3172 11.0198 12.4256 10.8523 12.4941 10.6719C12.5179 10.6086 12.5195 10.5403 12.498 10.4785C12.4664 10.3883 12.394 10.3159 12.3027 10.2754C12.1971 10.2285 12.0873 10.204 11.9785 10.2012C11.8635 10.1992 11.751 10.2163 11.6504 10.251C11.5442 10.2884 11.446 10.3503 11.3633 10.4316C11.2577 10.5119 11.134 10.5647 11.0039 10.582C10.8298 10.6051 10.6487 10.5726 10.4922 10.4902C10.4006 10.4383 10.299 10.3484 10.2344 10.2441C10.1713 10.1385 10.1503 10.0182 10.1758 9.90039C10.2199 9.70366 10.356 9.54118 10.542 9.46484C10.7263 9.3893 10.9343 9.42141 11.0859 9.54883C11.2066 9.64868 11.2796 9.80086 11.2832 9.95508C11.2837 9.98963 11.279 10.0241 11.2695 10.0566C11.2489 10.1254 11.2037 10.1857 11.1426 10.2266C11.0719 10.2746 10.9782 10.2908 10.8945 10.2695C10.8393 10.2556 10.7917 10.2199 10.7617 10.1699C10.7318 10.1199 10.7214 10.0606 10.7324 10.002C10.7509 9.91445 10.7929 9.83939 10.8516 9.7832C10.8923 9.74418 10.943 9.71739 10.998 9.70508C11.0619 9.69297 11.127 9.7034 11.1836 9.73438C11.2181 9.75341 11.2457 9.7862 11.2617 9.82617C11.2922 9.90806 11.3026 9.9968 11.292 10.0859C11.2902 10.1064 11.2714 10.1206 11.251 10.1211C11.2001 10.1222 11.1503 10.1112 11.1074 10.0898C11.043 10.0579 10.9804 10.0157 10.9258 9.96484C10.8848 9.92857 10.8554 9.88124 10.8418 9.82812C10.7953 9.69557 10.6903 9.5922 10.5566 9.55469C10.4257 9.51569 10.2819 9.5459 10.1758 9.63672C10.1454 9.66196 10.1162 9.69052 10.0938 9.72266C10.0449 9.79287 9.92552 9.89322 9.8457 9.93359C9.71332 9.99237 9.57614 10.059 9.42773 10.1309C9.36195 10.1638 9.29268 10.1924 9.2207 10.2148C9.14601 10.2379 9.06507 10.2442 8.98828 10.2324C8.87255 10.2138 8.75712 10.1882 8.64453 10.1562C8.46851 10.1058 8.31134 10.0461 8.17188 9.97852C8.04825 9.91719 7.93907 9.85181 7.84375 9.78125C7.82733 9.76899 7.80772 9.75915 7.78711 9.75391C7.74014 9.74169 7.69152 9.73361 7.64258 9.73047C7.6237 9.7289 7.60477 9.72912 7.58594 9.73047C7.47599 9.73786 7.36749 9.76297 7.26758 9.80469C7.18905 9.83424 7.11566 9.87678 7.05469 9.92969C6.99537 9.98022 6.94306 10.0429 6.90234 10.1152C6.78107 10.3221 6.67216 10.5392 6.57422 10.7637C6.56578 10.7802 6.5545 10.7947 6.54102 10.8066C6.51157 10.8348 6.47 10.8475 6.42969 10.8418C6.36922 10.8323 6.31835 10.7925 6.29883 10.7344C6.27531 10.6684 6.26035 10.6036 6.25195 10.541C6.24833 10.5144 6.24095 10.494 6.22266 10.4785C6.15713 10.4227 6.06535 10.3917 5.97266 10.3906C5.89528 10.3916 5.81812 10.4105 5.74805 10.4453C5.65288 10.4927 5.57211 10.5704 5.51758 10.666C5.46804 10.7534 5.44183 10.8533 5.44141 10.957C5.44124 11.0109 5.44838 11.0644 5.46289 11.1152C5.4846 11.1783 5.52318 11.2332 5.57422 11.2734C5.64047 11.3244 5.72003 11.3499 5.80078 11.3457C5.8869 11.3413 5.97184 11.3232 6.05273 11.292C6.08381 11.2803 6.1128 11.2617 6.13672 11.2383C6.16526 11.2096 6.18405 11.1736 6.18945 11.1357C6.2111 10.9765 6.24201 10.8216 6.28125 10.6719C6.29333 10.6241 6.32746 10.5853 6.37109 10.5645C6.61364 10.4536 6.85675 10.3439 7.10156 10.2363C7.14695 10.2168 7.19962 10.2168 7.24414 10.2344C7.30445 10.2576 7.36354 10.288 7.41992 10.3242C7.48001 10.3628 7.53283 10.416 7.57422 10.4805C7.64153 10.577 7.67649 10.6918 7.67383 10.8086C7.66797 11.0308 7.63429 11.2508 7.57422 11.4609C7.54168 11.5806 7.47531 11.6899 7.38477 11.7773C7.30769 11.8522 7.21401 11.9034 7.11133 11.9258C7.00957 11.9475 6.90328 11.9365 6.80859 11.8945C6.67982 11.838 6.54467 11.7909 6.40234 11.7559C6.31791 11.7364 6.23192 11.7227 6.14453 11.7148C6.07395 11.7081 6.00017 11.7246 5.94141 11.7617C5.87085 11.8068 5.81844 11.8731 5.79492 11.9512C5.7467 12.094 5.76795 12.2564 5.85352 12.3867C5.94672 12.5286 6.09372 12.6352 6.26562 12.6875C6.35642 12.7188 6.45177 12.7321 6.54688 12.7266C6.63315 12.7215 6.71786 12.7024 6.79688 12.6719C6.86634 12.644 6.92947 12.6018 6.98047 12.5488C7.05502 12.4735 7.108 12.3787 7.13281 12.2793C7.14451 12.2342 7.17127 12.1994 7.21094 12.1758C7.31026 12.1145 7.40942 12.0533 7.50781 11.9922C7.55706 11.962 7.60395 11.931 7.64844 11.8984C7.71959 11.8458 7.79762 11.8036 7.88086 11.7734C7.94692 11.7514 8.01795 11.7419 8.08789 11.7461C8.17278 11.751 8.25539 11.7724 8.33008 11.8086C8.42096 11.8559 8.50554 11.9182 8.58008 11.9922C8.65674 12.0686 8.71991 12.1587 8.76562 12.2578C8.79166 12.3163 8.81894 12.374 8.84375 12.4316C8.87136 12.4936 8.89402 12.5586 8.91016 12.625C8.92571 12.6863 8.95164 12.7434 8.98828 12.7949C9.05053 12.8822 9.13404 12.9527 9.23047 13.001C9.30602 13.0388 9.38672 13.0567 9.46875 13.0527C9.55911 13.0452 9.63804 13.0046 9.69531 12.9414C9.75174 12.8794 9.7807 12.8016 9.77734 12.7227C9.77342 12.6289 9.74015 12.5379 9.68164 12.4648C9.61918 12.3867 9.55085 12.315 9.47656 12.25C9.39395 12.1682 9.29707 12.095 9.19141 12.0332C9.06443 11.9608 8.91637 11.914 8.76172 11.8984C8.70237 11.8926 8.64282 11.8947 8.58594 11.9043C8.52538 11.9138 8.46994 11.9411 8.42773 11.9824C8.35156 12.0562 8.30763 12.1606 8.30469 12.2695C8.30105 12.3884 8.32568 12.5058 8.375 12.6152C8.41799 12.7075 8.48322 12.79 8.56445 12.8555C8.65344 12.9266 8.75658 12.9735 8.86719 12.9922C9.06149 13.0208 9.27514 12.9608 9.42773 12.834C9.46738 12.801 9.49903 12.7611 9.51953 12.7168C9.57261 12.5954 9.59082 12.4557 9.57227 12.3184C9.54821 12.1348 9.46069 11.9686 9.32422 11.8477C9.28069 11.8076 9.22488 11.7857 9.16602 11.7852C9.10561 11.7847 9.04871 11.8053 9.00391 11.8438C8.90816 11.9218 8.83437 12.0302 8.79297 12.1504C8.77735 12.1935 8.73839 12.2289 8.69141 12.2441C8.50599 12.3053 8.30843 12.265 8.16211 12.1309C8.01624 11.9962 7.9499 11.7987 7.98438 11.6094C8.00631 11.4868 8.09173 11.3981 8.21484 11.373C8.30702 11.354 8.39947 11.3449 8.49023 11.3457C8.61574 11.3468 8.73991 11.3777 8.84961 11.4355C8.9361 11.481 9.01374 11.5443 9.07812 11.6211C9.16236 11.7158 9.2275 11.8256 9.26758 11.9434C9.30262 12.0506 9.32212 12.166 9.32617 12.2812C9.3302 12.3931 9.30059 12.5032 9.24219 12.5996C9.19038 12.683 9.10731 12.744 9.00977 12.7695C8.90621 12.7964 8.79376 12.7784 8.70508 12.7207C8.56794 12.6306 8.45431 12.5054 8.38281 12.3594C8.33696 12.2675 8.31435 12.1679 8.31836 12.0684C8.32032 12.0229 8.3385 11.9789 8.36914 11.9434C8.43089 11.8698 8.52007 11.8194 8.61719 11.8008C8.81402 11.7646 9.02618 11.8119 9.18555 11.9316C9.29711 12.0156 9.36032 12.1495 9.36133 12.291C9.36292 12.374 9.34425 12.456 9.30664 12.5293C9.21678 12.6989 9.07629 12.8378 8.91016 12.9277C8.74292 13.0198 8.5483 13.056 8.35938 13.0312C8.27416 13.0201 8.19236 12.991 8.12109 12.9453C7.93911 12.8303 7.80922 12.6515 7.75781 12.4492C7.71616 12.2695 7.73214 12.084 7.80469 11.916C7.86649 11.776 7.98 11.6669 8.12305 11.6152C8.22334 11.5786 8.33051 11.5632 8.4375 11.5703C8.51597 11.5753 8.59206 11.5976 8.66016 11.6348C8.76158 11.6917 8.84255 11.7801 8.89062 11.8867C8.92608 11.9669 8.94667 12.0545 8.95117 12.1445C8.95567 12.2345 8.94384 12.3253 8.91602 12.4102C8.87124 12.545 8.7902 12.6624 8.68164 12.75C8.56263 12.8456 8.41743 12.9021 8.26562 12.9102C8.06973 12.9228 7.87555 12.8703 7.71289 12.7637C7.65441 12.7254 7.59922 12.6798 7.54883 12.6289C7.50057 12.5816 7.45632 12.5301 7.41602 12.4746C7.38795 12.4376 7.3656 12.3955 7.34961 12.3516C7.32979 12.3008 7.317 12.2477 7.3125 12.1934C7.30671 12.1318 7.31242 12.0698 7.32812 12.0098C7.36613 11.8926 7.42905 11.7876 7.51367 11.7031C7.63815 11.5771 7.82189 11.5097 8.00195 11.5195C8.13253 11.5302 8.25853 11.586 8.35742 11.6777C8.42636 11.7439 8.47704 11.8271 8.50391 11.916C8.53803 12.0363 8.53548 12.1675 8.49609 12.2852C8.4694 12.3631 8.42348 12.4317 8.36328 12.4844C8.28667 12.551 8.18864 12.5823 8.08984 12.5723C7.988 12.5613 7.89407 12.5099 7.82617 12.4277C7.78077 12.371 7.7561 12.3027 7.75781 12.2324C7.7591 12.155 7.78655 12.0799 7.83594 12.0176C7.88759 11.9517 7.96346 11.9025 8.04688 11.8789C8.08955 11.8669 8.13403 11.8611 8.17773 11.8613C8.28789 11.8613 8.39772 11.8836 8.49609 11.9258C8.59868 11.9689 8.68664 12.0363 8.75391 12.1211C8.81335 12.1973 8.85123 12.2892 8.86328 12.3848C8.8705 12.4511 8.85891 12.5191 8.83008 12.5801C8.7917 12.6625 8.73019 12.7359 8.65234 12.792C8.57619 12.8467 8.48317 12.8796 8.38672 12.8867C8.28867 12.894 8.19133 12.8727 8.10547 12.8262C7.97154 12.7539 7.86677 12.6352 7.81055 12.4961C7.77028 12.3966 7.75838 12.2885 7.77734 12.1836C7.80218 12.046 7.88666 11.9266 8.01367 11.8594C8.13449 11.7948 8.28443 11.7916 8.4082 11.8516C8.52861 11.9101 8.61208 12.028 8.62891 12.1621C8.63693 12.2271 8.62397 12.2937 8.5918 12.3516C8.55571 12.4077 8.50715 12.4535 8.45117 12.4863C8.39623 12.5185 8.3357 12.5368 8.27344 12.5391C8.17802 12.5422 8.08417 12.5157 8.00391 12.4648C7.9224 12.4127 7.85801 12.3346 7.82031 12.2422C7.77391 12.1253 7.77294 11.993 7.81836 11.875C7.88806 11.7006 8.04004 11.5694 8.22266 11.5234C8.40908 11.477 8.60756 11.5256 8.75391 11.6523C8.8952 11.7738 8.9708 11.9583 8.96289 12.1445C8.95412 12.3042 8.88286 12.452 8.76367 12.5605C8.65542 12.6576 8.5166 12.7143 8.37109 12.7207C8.21609 12.7276 8.06579 12.6825 7.95312 12.5957C7.75633 12.445 7.66397 12.1963 7.70703 11.9668C7.75166 11.7408 7.93209 11.5583 8.16016 11.5098C8.37741 11.4616 8.60078 11.5411 8.75 11.7168C8.89623 11.8885 8.93036 12.1296 8.83984 12.3359C8.75515 12.5244 8.56796 12.6564 8.35938 12.6777C8.14875 12.6977 7.93165 12.5964 7.80273 12.416C7.70161 12.2759 7.65639 12.1012 7.67773 11.9297C7.69778 11.7664 7.78038 11.6162 7.91016 11.5098C8.01034 11.4297 8.13622 11.3836 8.26562 11.3809C8.37437 11.3788 8.48171 11.4069 8.57617 11.4629C8.7641 11.5741 8.88371 11.7797 8.88672 12.002C8.89118 12.2678 8.73901 12.5181 8.5 12.6484C8.35108 12.7296 8.17514 12.7632 8.00586 12.7422C7.83064 12.7207 7.67283 12.6329 7.56055 12.4961C7.37013 12.2582 7.34983 11.9253 7.50977 11.6719C7.66161 11.432 7.95203 11.3189 8.21875 11.3867C8.37914 11.4292 8.515 11.5377 8.5957 11.6855C8.65912 11.8021 8.68119 11.9403 8.6582 12.0723C8.63357 12.1849 8.57842 12.2899 8.5 12.375C8.38981 12.4965 8.24122 12.575 8.08105 12.5977C7.91052 12.6206 7.73497 12.5921 7.58594 12.5176C7.439 12.444 7.31726 12.3333 7.23633 12.1953C7.16469 12.0721 7.13864 11.9252 7.16211 11.7793C7.18868 11.6107 7.28399 11.4605 7.42578 11.3613C7.56651 11.2636 7.74357 11.2244 7.91016 11.252C8.06521 11.2777 8.20692 11.3627 8.30664 11.4902C8.39476 11.6035 8.43992 11.7476 8.43555 11.8926C8.42889 12.0123 8.38321 12.1262 8.30664 12.2207C8.2344 12.3113 8.13165 12.3778 8.01758 12.4082C7.8916 12.4424 7.75418 12.4373 7.63281 12.3945C7.49163 12.346 7.37096 12.2502 7.28906 12.126C7.19774 11.9853 7.16217 11.812 7.18945 11.6445C7.21349 11.497 7.29318 11.357 7.41797 11.2617C7.52578 11.1807 7.65831 11.1415 7.79102 11.1523C7.88706 11.159 7.97903 11.1938 8.05664 11.251C8.14559 11.3178 8.21044 11.4119 8.24414 11.5195C8.26578 11.5919 8.27564 11.6683 8.27344 11.7422C8.26182 11.9437 8.13566 12.1246 7.95312 12.2109C7.81133 12.2788 7.64584 12.2839 7.5 12.2246C7.35198 12.1637 7.2266 12.0436 7.1543 11.8945C7.07564 11.7344 7.05669 11.5463 7.09961 11.373C7.14747 11.1823 7.28992 11.027 7.47852 10.9609C7.65716 10.8971 7.85652 10.9319 8.00586 11.0527C8.16821 11.1822 8.25353 11.398 8.23633 11.6094C8.22881 11.7049 8.19675 11.7981 8.14453 11.8789C8.07166 11.9907 7.9647 12.0757 7.83984 12.123C7.67384 12.1867 7.48568 12.177 7.33008 12.0957C7.20368 12.0287 7.1052 11.9147 7.05664 11.7773C7.01796 11.6648 7.01483 11.5415 7.04688 11.4238C7.09198 11.2482 7.21796 11.105 7.38477 11.042C7.56705 10.974 7.77511 11.018 7.91602 11.1582C8.05015 11.2879 8.10114 11.4837 8.05469 11.6602C8.03336 11.7395 7.98528 11.8098 7.91992 11.8613C7.84622 11.9184 7.75435 11.9504 7.66016 11.9512C7.565 11.9501 7.47407 11.9173 7.40039 11.8574C7.26976 11.7504 7.19094 11.5836 7.19727 11.4121C7.2 11.3416 7.2154 11.2728 7.24219 11.2109"
      fill={COLORS.textSecondary}
      stroke={COLORS.white}
      strokeWidth="0.1"
    />
  </Svg>
);




export type PersonType = 'fisica' | 'juridica';
export type ScreenMode = 'criar' | 'editar';

export interface ProfileFormData {
  nome: string;
  cpfCnpj: string;
  email: string;
  whatsapp: string;
  estado: string;
  cep: string;
  cidade: string;
  bairro: string;
  endereco: string;
  numero: string;
  complemento: string;
  keymanPhoto?: any;
}

interface InformationGroupProfileProps {
  mode: ScreenMode;
  formData: ProfileFormData;
  onUpdateFormField: (field: keyof ProfileFormData, value: string) => void;
  personType: PersonType;
  onSetPersonType: (type: PersonType) => void;
}

const InformationGroupProfile: React.FC<InformationGroupProfileProps> = ({
  mode,
  formData,
  onUpdateFormField,
  personType,
  onSetPersonType,
}) => {
  const [focusedField, setFocusedField] = useState<string | null>(null);
  const [touched, setTouched] = useState<{ [key in keyof ProfileFormData]?: boolean }>({});
  const [errors, setErrors] = useState<Partial<Record<keyof ProfileFormData, string>>>({});
  const BRAZIL_STATES: string[] = useMemo(() => ([
    'AC - Acre','AL - Alagoas','AP - Amapá','AM - Amazonas','BA - Bahia','CE - Ceará','DF - Distrito Federal',
    'ES - Espírito Santo','GO - Goiás','MA - Maranhão','MT - Mato Grosso','MS - Mato Grosso do Sul','MG - Minas Gerais',
    'PA - Pará','PB - Paraíba','PR - Paraná','PE - Pernambuco','PI - Piauí','RJ - Rio de Janeiro','RN - Rio Grande do Norte',
    'RS - Rio Grande do Sul','RO - Rondônia','RR - Roraima','SC - Santa Catarina','SP - São Paulo','SE - Sergipe','TO - Tocantins',
  ]), []);
  const UF_NAME_MAP: Record<string, string> = useMemo(() => {
    return BRAZIL_STATES.reduce((acc, label) => {
      const [uf] = label.split(' - ');
      acc[uf] = label;
      return acc;
    }, {} as Record<string, string>);
  }, [BRAZIL_STATES]);
  const [stateDropdownOpen, setStateDropdownOpen] = useState(false);
  const [stateSearch, setStateSearch] = useState('');
  const chevronAnim = useRef(new Animated.Value(0)).current;
  const chevronRotate = chevronAnim.interpolate({ inputRange: [0, 1], outputRange: ['-90deg', '0deg'] });
  useEffect(() => {
    Animated.timing(chevronAnim, { toValue: stateDropdownOpen ? 1 : 0, duration: 200, useNativeDriver: true }).start();
  }, [stateDropdownOpen]);
  const filteredStates = useMemo(
    () => {
      const normalizeText = (str: string) =>
        (str || '')
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .toLowerCase()
          .trim();
      const q = normalizeText(stateSearch);
      return BRAZIL_STATES.filter((s) => normalizeText(s).includes(q));
    },
    [BRAZIL_STATES, stateSearch]
  );
  useEffect(() => {
    const val = String(formData.estado || '');
    if (val && !UF_LIST.includes(val) && val.length > 2) {
      const m = BRAZIL_STATES.find((label) => label.endsWith(' - ' + val));
      if (m) {
        const uf = m.split(' - ')[0];
        onUpdateFormField('estado', uf);
      }
    }
  }, [formData.estado]);
  // ===== BLOCO: FOTO DO KEYMAN =====
  const getProfilePhotoSource = () => {
    if (formData.keymanPhoto) return formData.keymanPhoto;
    if (mode === 'criar') return DEFAULT_AVATAR;
    const mapped = KEYMAN_PHOTO_BY_NAME[(formData.nome || '').trim()];
    if (mapped) return mapped;
    return DEFAULT_AVATAR;
  };

  const onPickProfilePhoto = async () => {
    try {
      if (Platform.OS !== 'web') {
        const permission = await ImagePicker.requestMediaLibraryPermissionsAsync();
        if (!permission.granted) return;
      }

      const result = await ImagePicker.launchImageLibraryAsync({
        mediaTypes: ImagePicker.MediaTypeOptions.Images,
        allowsEditing: true,
        quality: 1,
      });

      if (result.canceled) return;
      const asset = result.assets?.[0];
      if (!asset?.uri) return;

      (onUpdateFormField as any)('keymanPhoto', { uri: asset.uri });
    } catch {
      return;
    }
  };

  const updateFormField = (field: keyof ProfileFormData, value: string) => {
    onUpdateFormField(field, value);
  };

  const renderPersonalInputs = () => (
    <>
      <View style={styles.inputGroup}>
        <View style={styles.labelContainer}>
          <Text style={styles.inputLabel}>Nome*</Text>
        </View>
        <View style={[styles.inputContainer, focusedField === 'nome' ? styles.inputFocused : null]}>
          <TextInput
            style={styles.input}
            value={formData.nome}
            onChangeText={(value) => {
              const formatted = formatNameFirstWordOnly(value);
              updateFormField('nome', formatted);
              const valid = formatted.trim().split(/\s+/).filter(Boolean).length >= 2;
              setErrors({ ...errors, nome: valid ? undefined : 'Informe nome completo (mínimo duas palavras).' });
            }}
            onFocus={() => setFocusedField('nome')}
            onBlur={() => { setFocusedField(null); setTouched({ ...touched, nome: true }); }}
            placeholder={getPlaceholderForField('nome', personType)}
            placeholderTextColor={COLORS.textTertiary}
            selectionColor={COLORS.primary}
            cursorColor={COLORS.primary}
          />
        </View>
        {(errors.nome && touched.nome) ? <Text style={styles.errorText}>{errors.nome}</Text> : null}
      </View>

      <View style={styles.inputGroup}>
        <View style={styles.labelContainer}>
          <Text style={styles.inputLabel}>{personType === 'fisica' ? 'CPF*' : 'CNPJ*'}</Text>
        </View>
        <View style={[styles.inputContainer, focusedField === 'cpfCnpj' ? styles.inputFocused : null]}>
          <TextInput
            style={styles.input}
            value={formData.cpfCnpj}
            onChangeText={(value) => {
              if (personType === 'fisica') {
                const masked = maskCPF(value);
                updateFormField('cpfCnpj', masked);
                const valid = isValidCPF(masked);
                setErrors({ ...errors, cpfCnpj: valid || masked.length < 14 ? undefined : 'CPF inválido.' });
              } else {
                const masked = maskCNPJ(value);
                updateFormField('cpfCnpj', masked);
                const valid = isValidCNPJ(masked);
                setErrors({ ...errors, cpfCnpj: valid || masked.length < 18 ? undefined : 'CNPJ inválido.' });
              }
            }}
            onFocus={() => setFocusedField('cpfCnpj')}
            onBlur={() => { setFocusedField(null); setTouched({ ...touched, cpfCnpj: true }); }}
            placeholder={getPlaceholderForField('cpfCnpj', personType)}
            placeholderTextColor={COLORS.textTertiary}
            keyboardType="numeric"
            maxLength={personType === 'fisica' ? 14 : 18}
            selectionColor={COLORS.primary}
            cursorColor={COLORS.primary}
          />
        </View>
        {(errors.cpfCnpj && touched.cpfCnpj) ? <Text style={styles.errorText}>{errors.cpfCnpj}</Text> : null}
      </View>

      <View style={styles.inputGroup}>
        <View style={styles.labelContainer}>
          <Text style={styles.inputLabel}>Email*</Text>
        </View>
        <View style={[styles.inputContainer, focusedField === 'email' ? styles.inputFocused : null]}>
          <TextInput
            style={styles.input}
            value={formData.email}
            onChangeText={(value) => {
              const sanitized = sanitizeEmail(value);
              updateFormField('email', sanitized);
              const valid = isValidEmail(sanitized);
              setErrors({ ...errors, email: valid ? undefined : 'Email inválido.' });
            }}
            onFocus={() => setFocusedField('email')}
            onBlur={() => { setFocusedField(null); setTouched({ ...touched, email: true }); }}
            placeholder={getPlaceholderForField('email', personType)}
            placeholderTextColor={COLORS.textTertiary}
            keyboardType="email-address"
            autoCapitalize="none"
            selectionColor={COLORS.primary}
            cursorColor={COLORS.primary}
          />
        </View>
        {(errors.email && touched.email) ? <Text style={styles.errorText}>{errors.email}</Text> : null}
      </View>

      <View style={styles.inputGroup}>
        <View style={styles.labelContainer}>
          <Text style={styles.inputLabel}>WhatsApp</Text>
        </View>
        <View style={[styles.inputContainer, focusedField === 'whatsapp' ? styles.inputFocused : null]}>
          <TextInput
            style={styles.input}
            value={formData.whatsapp}
            onChangeText={(value) => {
              const masked = maskWhatsApp(value);
              updateFormField('whatsapp', masked);
              const info = validateWhatsApp(masked);
              const digits = (masked || '').replace(/\D+/g, '');
              setErrors({ ...errors, whatsapp: info.valid || digits.length < 10 ? undefined : 'WhatsApp inválido (DDD e comprimento).' });
            }}
            onFocus={() => setFocusedField('whatsapp')}
            onBlur={() => { setFocusedField(null); setTouched({ ...touched, whatsapp: true }); }}
            placeholder={getPlaceholderForField('whatsapp', personType)}
            placeholderTextColor={COLORS.textTertiary}
            keyboardType="phone-pad"
            selectionColor={COLORS.primary}
            cursorColor={COLORS.primary}
          />
        </View>
        {(errors.whatsapp && touched.whatsapp) ? <Text style={styles.errorText}>{errors.whatsapp}</Text> : null}
      </View>
    </>
  );

  const renderLocationInputs = () => (
    <>
      <View style={styles.inputGroup}>
        <View style={styles.labelContainer}>
          <Text style={styles.inputLabel}>Estado</Text>
        </View>
        <TouchableOpacity
          style={[styles.inputContainer, styles.stateSelectRow, focusedField === 'estado' ? styles.inputFocused : null]}
          onPress={() => { setFocusedField('estado'); setStateDropdownOpen((o) => !o); }}
          accessibilityLabel="Seletor de estado"
        >
          <Text style={[styles.dropdownText, !formData.estado ? styles.placeholderText : null]}>
            {formData.estado ? (UF_NAME_MAP[formData.estado] || formData.estado) : 'Selecione um estado'}
          </Text>
          <Animated.View style={[styles.dropdownChevron, { transform: [{ rotate: chevronRotate }] }]}>
            <ChevronDownIcon />
          </Animated.View>
        </TouchableOpacity>
        {(errors.estado && touched.estado) ? <Text style={styles.errorText}>{errors.estado}</Text> : null}
      </View>

      <Modal
        visible={stateDropdownOpen}
        transparent
        animationType="fade"
        onRequestClose={() => {
          setStateDropdownOpen(false);
          setTouched({ ...touched, estado: true });
          setErrors({ ...errors, estado: formData.estado && (UF_LIST.includes(formData.estado) || !!UF_NAME_MAP[formData.estado]) ? undefined : 'Selecione um estado válido.' });
        }}
      >
        <TouchableWithoutFeedback
          onPress={() => {
            setStateDropdownOpen(false);
            setTouched({ ...touched, estado: true });
            setErrors({ ...errors, estado: formData.estado && (UF_LIST.includes(formData.estado) || !!UF_NAME_MAP[formData.estado]) ? undefined : 'Selecione um estado válido.' });
          }}
        >
          <View style={styles.modalBackdrop} />
        </TouchableWithoutFeedback>
        <View style={styles.dropdownModalContainer} pointerEvents="box-none">
          <View style={styles.dropdownContainer}>
            <View style={styles.searchBar}>
              <TextInput
                style={[
                  styles.input,
                  styles.searchInput,
                  Platform.OS === 'web' ? ({ outlineStyle: 'none', outlineWidth: 0 } as any) : null,
                ]}
                placeholder="Buscar estado"
                placeholderTextColor={COLORS.textTertiary}
                value={stateSearch}
                onChangeText={setStateSearch}
                autoCapitalize="none"
                autoCorrect={false}
                autoComplete="off"
                selectionColor={COLORS.primary}
                cursorColor={COLORS.primary}
              />
              {stateSearch.length > 0 && (
                <TouchableOpacity
                  style={styles.clearBtn}
                  onPress={() => setStateSearch('')}
                  accessibilityLabel="Limpar busca"
                  hitSlop={{ top: 8, bottom: 8, left: 8, right: 8 }}
                >
                  <ClearIcon />
                </TouchableOpacity>
              )}
            </View>
            <Animated.ScrollView style={styles.stateList as any}>
              {filteredStates.map((label) => (
                <View key={label}>
                  <TouchableOpacity
                    style={[styles.stateItem, (UF_NAME_MAP[formData.estado] === label) && styles.stateItemSelected]}
                    onPress={() => {
                      const uf = label.split(' - ')[0];
                      updateFormField('estado', uf);
                      setErrors({ ...errors, estado: undefined });
                      setStateSearch('');
                      setStateDropdownOpen(false);
                      setFocusedField(null);
                      setTouched({ ...touched, estado: true });
                    }}
                    accessibilityLabel={'Selecionar estado ' + label}
                  >
                    <Text style={styles.stateItemText}>{label}</Text>
                  </TouchableOpacity>
                  <View style={styles.stateDivider} />
                </View>
              ))}
            </Animated.ScrollView>
          </View>
        </View>
      </Modal>

      <View style={styles.inputGroup}>
        <View style={styles.labelContainer}>
          <Text style={styles.inputLabel}>CEP</Text>
        </View>
        <View style={[styles.inputContainer, focusedField === 'cep' ? styles.inputFocused : null]}>
          <TextInput
            style={styles.input}
            value={formData.cep}
            onChangeText={(value) => {
              const masked = maskCEP(value);
              updateFormField('cep', masked);
              const valid = isValidCEP(masked);
              setErrors({ ...errors, cep: valid || masked.length < 9 ? undefined : 'CEP inválido.' });
            }}
            onFocus={() => setFocusedField('cep')}
            onBlur={() => { setFocusedField(null); setTouched({ ...touched, cep: true }); }}
            placeholder={getPlaceholderForField('cep', personType)}
            placeholderTextColor={COLORS.textTertiary}
            keyboardType="numeric"
            maxLength={9}
            selectionColor={COLORS.primary}
            cursorColor={COLORS.primary}
          />
        </View>
        {(errors.cep && touched.cep) ? <Text style={styles.errorText}>{errors.cep}</Text> : null}
      </View>

      <View style={styles.inputGroup}>
        <View style={styles.labelContainer}>
          <Text style={styles.inputLabel}>Cidade</Text>
        </View>
        <View style={[styles.inputContainer, focusedField === 'cidade' ? styles.inputFocused : null]}>
          <TextInput
            style={styles.input}
            value={formData.cidade}
            onChangeText={(value) => {
              const sanitized = sanitizeCityNeighborhood(value);
              const cleaned = capitalizeFirstLetterLive(sanitized);
              updateFormField('cidade', cleaned);
              setErrors({ ...errors, cidade: cleaned.trim() ? undefined : 'Cidade é obrigatória.' });
            }}
            onFocus={() => setFocusedField('cidade')}
            onBlur={() => { setFocusedField(null); setTouched({ ...touched, cidade: true }); }}
            placeholder={getPlaceholderForField('cidade', personType)}
            placeholderTextColor={COLORS.textTertiary}
            selectionColor={COLORS.primary}
            cursorColor={COLORS.primary}
          />
        </View>
        {(errors.cidade && touched.cidade) ? <Text style={styles.errorText}>{errors.cidade}</Text> : null}
      </View>

      <View style={styles.inputGroup}>
        <View style={styles.labelContainer}>
          <Text style={styles.inputLabel}>Bairro</Text>
        </View>
        <View style={[styles.inputContainer, focusedField === 'bairro' ? styles.inputFocused : null]}>
          <TextInput
            style={styles.input}
            value={formData.bairro}
            onChangeText={(value) => {
              const sanitized = sanitizeCityNeighborhood(value);
              const cleaned = capitalizeFirstLetterLive(sanitized);
              updateFormField('bairro', cleaned);
              setErrors({ ...errors, bairro: cleaned.trim() ? undefined : 'Bairro é obrigatório.' });
            }}
            onFocus={() => setFocusedField('bairro')}
            onBlur={() => { setFocusedField(null); setTouched({ ...touched, bairro: true }); }}
            placeholder={getPlaceholderForField('bairro', personType)}
            placeholderTextColor={COLORS.textTertiary}
            selectionColor={COLORS.primary}
            cursorColor={COLORS.primary}
          />
        </View>
        {(errors.bairro && touched.bairro) ? <Text style={styles.errorText}>{errors.bairro}</Text> : null}
      </View>

      <View style={styles.inputGroup}>
        <View style={styles.labelContainer}>
          <Text style={styles.inputLabel}>Endereço</Text>
        </View>
        <View style={[styles.inputContainer, focusedField === 'endereco' ? styles.inputFocused : null]}>
          <TextInput
            style={styles.input}
            value={formData.endereco}
            onChangeText={(value) => {
              const sanitized = sanitizeAddress(value);
              const cleaned = capitalizeFirstLetterLive(sanitized);
              updateFormField('endereco', cleaned);
              setErrors({ ...errors, endereco: cleaned.trim() ? undefined : 'Endereço é obrigatório.' });
            }}
            onFocus={() => setFocusedField('endereco')}
            onBlur={() => { setFocusedField(null); setTouched({ ...touched, endereco: true }); }}
            placeholder={getPlaceholderForField('endereco', personType)}
            placeholderTextColor={COLORS.textTertiary}
            selectionColor={COLORS.primary}
            cursorColor={COLORS.primary}
          />
        </View>
        {(errors.endereco && touched.endereco) ? <Text style={styles.errorText}>{errors.endereco}</Text> : null}
      </View>

      <View style={styles.inputGroup}>
        <View style={styles.labelContainer}>
          <Text style={styles.inputLabel}>Número</Text>
        </View>
        <View style={[styles.inputContainer, focusedField === 'numero' ? styles.inputFocused : null]}>
          <TextInput
            style={styles.input}
            value={formData.numero}
            onChangeText={(value) => {
              const cleaned = sanitizeNumberField(value, 6);
              updateFormField('numero', cleaned);
              setErrors({ ...errors, numero: cleaned.trim() ? undefined : 'Número é obrigatório.' });
            }}
            onFocus={() => setFocusedField('numero')}
            onBlur={() => { setFocusedField(null); setTouched({ ...touched, numero: true }); }}
            placeholder={getPlaceholderForField('numero', personType)}
            placeholderTextColor={COLORS.textTertiary}
            keyboardType="numeric"
            selectionColor={COLORS.primary}
            cursorColor={COLORS.primary}
          />
        </View>
        {(errors.numero && touched.numero) ? <Text style={styles.errorText}>{errors.numero}</Text> : null}
      </View>

      <View style={styles.inputGroup}>
        <View style={styles.labelContainer}>
          <Text style={styles.inputLabel}>Complemento</Text>
        </View>
        <View style={[styles.inputContainer, focusedField === 'complemento' ? styles.inputFocused : null]}>
          <TextInput
            style={styles.input}
            value={formData.complemento}
            onChangeText={(value) => {
              const sanitized = sanitizeComplement(value);
              const cleaned = capitalizeFirstLetterLive(sanitized);
              updateFormField('complemento', cleaned);
            }}
            onFocus={() => setFocusedField('complemento')}
            onBlur={() => { setFocusedField(null); setTouched({ ...touched, complemento: true }); }}
            placeholder={getPlaceholderForField('complemento', personType)}
            placeholderTextColor={COLORS.textTertiary}
            selectionColor={COLORS.primary}
            cursorColor={COLORS.primary}
          />
        </View>
      </View>
    </>
  );

  const renderProfileForm = () => (
    <ScrollView
      style={styles.formContainer}
      showsVerticalScrollIndicator={false}
    >
      <View style={styles.formContent}>
        {/* Título */}
        <View style={styles.titleSection}>
          <Text style={styles.screenTitle}>
            {mode === 'criar' ? 'Criar Perfil' : 'Editar Perfil'}
          </Text>
          <View style={styles.titleDivider} />
        </View>

        {/* Foto e tipo de pessoa */}
        <View style={styles.photoTypeSection}>
          <View style={styles.photoContainer}>
            <Image
              source={getProfilePhotoSource()}
              style={styles.profilePhoto}
            />
            <TouchableOpacity
              style={styles.cameraButton}
              onPress={onPickProfilePhoto}
              activeOpacity={0.8}
              hitSlop={{ top: 8, bottom: 8, left: 8, right: 8 }}
            >
              <CameraIcon />
            </TouchableOpacity>
          </View>

          <View style={styles.personTypeContainer}>
            <TouchableOpacity
              style={styles.radioOption}
              onPress={() => onSetPersonType('fisica')}
            >
              {personType === 'fisica' ? <RadioSelectedIcon /> : <RadioUnselectedIcon />}
              <Text style={styles.radioLabel}>Fisica</Text>
            </TouchableOpacity>

            <View style={styles.radioOptionDivider} />

            <TouchableOpacity
              style={styles.radioOption}
              onPress={() => onSetPersonType('juridica')}
            >
              {personType === 'juridica' ? <RadioSelectedIcon /> : <RadioUnselectedIcon />}
              <Text style={styles.radioLabel}>Jurídica</Text>
            </TouchableOpacity>
          </View>
        </View>

        {/* Dados pessoais */}
        <View style={styles.sectionContainer}>
          <Text style={styles.sectionTitle}>Dados pessoais:</Text>
          {renderPersonalInputs()}
        </View>

        {/* Localização */}
        <View style={styles.sectionContainer}>
          <Text style={styles.sectionTitle}>Localização:</Text>
          {renderLocationInputs()}
        </View>
      </View>
    </ScrollView>
  );
  return renderProfileForm();
};

// ===== BLOCO: ESTILOS =====
const styles = StyleSheet.create({
  // Containers
  formContainer: {
    flex: 1,
    paddingHorizontal: 16,
  },
  formContent: {
    paddingTop: 2,
    paddingBottom: 0,
    gap: 15,
  },
  // Título
  titleSection: {
    gap: 10,
  },
  screenTitle: {
    fontFamily: 'Inter_700Bold',
    fontSize: 18,
    color: COLORS.textPrimary,
    lineHeight: 24,
  },
  // Divisória do título
  titleDivider: {
    height: 0.5,
    backgroundColor: COLORS.border,
    marginVertical: 5,
  },
  // Foto e tipo de pessoa
  photoTypeSection: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 12,
    paddingLeft: 3,
    marginBottom: 10,
  },
  photoContainer: {
    position: 'relative',
    overflow: 'visible',
  },
  // Foto de perfil
  profilePhoto: {
    width: 65,
    height: 80,
    borderRadius: 8,
    borderWidth: 1,
    borderColor: COLORS.border,
  },
  // Botão de câmera sobre a foto
  cameraButton: {
    position: 'absolute',
    top: 63,
    marginTop: 4,
    left: '50%',
    marginLeft: -12.5,
  },
  // Seletores de tipo de pessoa
  personTypeContainer: {
    backgroundColor: COLORS.white,
    gap: 10,
  },
  radioOption: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 10,
  },
  // Divisória entre opções do seletor
  radioOptionDivider: {
    height: 0.5,
    backgroundColor: COLORS.border,
  },
  // Textos
  radioLabel: {
    fontFamily: 'Inter_400Regular',
    fontSize: 16,
    color: COLORS.textPrimary,
  },
  // Seções
  sectionContainer: {
    gap: 10,
    paddingBottom: 10,
  },
  sectionTitle: {
    fontFamily: 'Inter_600SemiBold',
    fontSize: 16,
    color: '#0F172A',
    paddingHorizontal: 5,
  },
  // Inputs
  inputGroup: {
    minHeight: 64,
    gap: 6,
  },
  labelContainer: {
    paddingHorizontal: 6,
  },
  inputLabel: {
    fontFamily: 'Inter_600SemiBold',
    fontSize: 12,
    color: COLORS.labelText,
  },
  inputContainer: {
    height: 36,
    borderRadius: 8,
    borderWidth: 0.5,
    borderColor: COLORS.border,
    justifyContent: 'center',
    paddingHorizontal: 10,
  },
  input: {
    flex: 1,
    fontFamily: 'Inter_400Regular',
    fontSize: 14,
    color: COLORS.textPrimary,
    ...(Platform.OS === 'web'
      ? ({
          outlineStyle: 'none',
          outlineWidth: 0,
          outlineColor: 'transparent',
        } as any)
      : {}),
  },
  inputFocused: {
    borderColor: COLORS.primary,
  },
  errorText: {
    color: '#D94F4F',
    fontFamily: 'Inter_400Regular',
    fontSize: 12,
    marginTop: 4,
    marginBottom: 10,
    paddingHorizontal: 6,
  },
  stateSelectRow: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
  },
  dropdownText: {
    fontSize: 14,
    fontFamily: 'Inter_400Regular',
    color: COLORS.textPrimary,
    flex: 1,
  },
  placeholderText: {
    color: COLORS.textTertiary,
  },
  dropdownChevron: {
    marginLeft: 8,
  },
  dropdownModalContainer: {
    position: 'absolute',
    left: 0,
    right: 0,
    top: 0,
    bottom: 0,
    alignItems: 'center',
    justifyContent: 'center',
  },
  modalBackdrop: {
    position: 'absolute',
    left: 0,
    right: 0,
    top: 0,
    bottom: 0,
    backgroundColor: 'rgba(0,0,0,0.3)',
  },
  dropdownContainer: {
    width: '90%',
    maxWidth: 420,
    minWidth: 320,
    backgroundColor: COLORS.white,
    borderRadius: 8,
    borderWidth: 0.5,
    borderColor: COLORS.border,
    padding: 10,
  },
  searchBar: {
    flexDirection: 'row',
    alignItems: 'center',
    borderWidth: 1,
    borderColor: COLORS.inputBorder,
    borderRadius: 8,
    paddingHorizontal: 10,
    height: 44,
    marginBottom: 10,
    backgroundColor: COLORS.white,
  },
  searchInput: {
    flex: 1,
    height: '100%',
    borderWidth: 0,
    paddingHorizontal: 0,
    color: COLORS.textPrimary,
    fontFamily: 'Inter_400Regular',
    fontSize: 14,
    backgroundColor: 'transparent',
  },
  clearBtn: {
    marginLeft: 8,
    width: 24,
    height: 24,
    alignItems: 'center',
    justifyContent: 'center',
  },
  stateList: {
    height: 320,
  },
  stateItem: {
    paddingVertical: 8,
    paddingHorizontal: 5,
  },
  stateItemSelected: {
    backgroundColor: '#F4F4F4',
    borderRadius: 6,
  },
  stateItemText: {
    fontSize: 14,
    fontFamily: 'Inter_400Regular',
    color: COLORS.textPrimary,
  },
  stateDivider: {
    height: 0.5,
    backgroundColor: COLORS.border,
  },
});

export default InformationGroupProfile;
